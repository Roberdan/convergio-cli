# ============================================================================
# CONVERGIO TEST MAKEFILE (REF-07)
#
# Extracted test macros and quality gates for cleaner build system.
# Include from main Makefile: include Makefile.test
#
# Copyright 2025 - Roberto D'Angelo & AI Team
# ============================================================================

# Test directories
TEST_DIR := tests
TEST_BIN_DIR := $(BUILD_DIR)/tests

# Test sources
TEST_SOURCES := $(wildcard $(TEST_DIR)/test_*.c)
TEST_TARGETS := $(patsubst $(TEST_DIR)/%.c,$(TEST_BIN_DIR)/%,$(TEST_SOURCES))

# Test flags
TEST_CFLAGS := $(CFLAGS) -I$(TEST_DIR) -DTEST_BUILD

# ============================================================================
# TEST COMPILATION
# ============================================================================

$(TEST_BIN_DIR):
	@mkdir -p $@

$(TEST_BIN_DIR)/test_%: $(TEST_DIR)/test_%.c $(OBJECTS) | $(TEST_BIN_DIR)
	@echo "$(COLOR_CYAN)Compiling test: $<$(COLOR_RESET)"
	@$(CC) $(TEST_CFLAGS) -o $@ $< $(filter-out %/main.o,$(OBJECTS)) $(LDFLAGS)

# ============================================================================
# TEST TARGETS
# ============================================================================

.PHONY: test test-unit test-integration test-e2e test-coverage test-verbose

## Run all tests
test: $(TEST_TARGETS)
	@echo "$(COLOR_BOLD)$(COLOR_GREEN)Running all tests...$(COLOR_RESET)"
	@passed=0; failed=0; \
	for test in $(TEST_TARGETS); do \
		echo ""; \
		echo "$(COLOR_CYAN)>>> $$test$(COLOR_RESET)"; \
		if $$test; then \
			passed=$$((passed + 1)); \
		else \
			failed=$$((failed + 1)); \
		fi; \
	done; \
	echo ""; \
	echo "$(COLOR_BOLD)=== Test Summary ===$(COLOR_RESET)"; \
	echo "$(COLOR_GREEN)Passed: $$passed$(COLOR_RESET)"; \
	if [ $$failed -gt 0 ]; then \
		echo "$(COLOR_RED)Failed: $$failed$(COLOR_RESET)"; \
		exit 1; \
	fi

## Run unit tests only
test-unit: $(filter %_unit,$(TEST_TARGETS))
	@for test in $^; do $$test; done

## Run integration tests only
test-integration: $(filter %_integration,$(TEST_TARGETS))
	@for test in $^; do $$test; done

## Run E2E tests only
test-e2e:
	@echo "$(COLOR_CYAN)Running E2E tests...$(COLOR_RESET)"
	@$(TEST_DIR)/test_acp_e2e.sh

## Run tests with verbose output
test-verbose: TEST_CFLAGS += -DTEST_VERBOSE
test-verbose: test

## Run tests with coverage (requires gcov)
test-coverage: CFLAGS += --coverage
test-coverage: LDFLAGS += --coverage
test-coverage: clean test
	@echo "$(COLOR_CYAN)Generating coverage report...$(COLOR_RESET)"
	@gcov $(TEST_SOURCES) 2>/dev/null || echo "gcov not available"
	@lcov --capture --directory . --output-file coverage.info 2>/dev/null || true
	@genhtml coverage.info --output-directory coverage_report 2>/dev/null || true
	@echo "Coverage report: coverage_report/index.html"

# ============================================================================
# QUALITY GATES
# ============================================================================

.PHONY: quality lint format check-format security-scan

## Run all quality checks
quality: lint check-format security-scan test
	@echo "$(COLOR_GREEN)All quality gates passed!$(COLOR_RESET)"

## Run linter (cppcheck)
lint:
	@echo "$(COLOR_CYAN)Running cppcheck...$(COLOR_RESET)"
	@cppcheck --enable=warning,performance,portability \
		--suppress=missingIncludeSystem \
		--error-exitcode=1 \
		$(SRC_DIR) 2>&1 | head -50

## Format code (clang-format)
format:
	@echo "$(COLOR_CYAN)Formatting code...$(COLOR_RESET)"
	@find $(SRC_DIR) $(INCLUDE_DIR) -name '*.c' -o -name '*.h' | \
		xargs clang-format -i -style=file 2>/dev/null || true

## Check formatting without modifying
check-format:
	@echo "$(COLOR_CYAN)Checking format...$(COLOR_RESET)"
	@find $(SRC_DIR) $(INCLUDE_DIR) -name '*.c' -o -name '*.h' | \
		xargs clang-format --dry-run -Werror -style=file 2>/dev/null || \
		echo "$(COLOR_YELLOW)Format check skipped (clang-format not available)$(COLOR_RESET)"

## Run security scan
security-scan:
	@echo "$(COLOR_CYAN)Running security scan...$(COLOR_RESET)"
	@cppcheck --enable=warning \
		--suppress=missingIncludeSystem \
		$(SRC_DIR) 2>&1 | grep -i "security\|buffer\|overflow\|injection" || \
		echo "$(COLOR_GREEN)No obvious security issues found$(COLOR_RESET)"

# ============================================================================
# TEST CLEANUP
# ============================================================================

.PHONY: test-clean

test-clean:
	@rm -rf $(TEST_BIN_DIR)
	@rm -f *.gcov *.gcda *.gcno coverage.info
	@rm -rf coverage_report

# ============================================================================
# HELPER MACROS
# ============================================================================

# Color definitions (if not defined in main Makefile)
COLOR_RESET ?= \033[0m
COLOR_BOLD ?= \033[1m
COLOR_GREEN ?= \033[32m
COLOR_RED ?= \033[31m
COLOR_CYAN ?= \033[36m
COLOR_YELLOW ?= \033[33m
