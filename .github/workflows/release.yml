name: Release

on:
  push:
    tags:
      - 'v*'

permissions:
  contents: write

env:
  DEVELOPER_ID: "Developer ID Application: Fight The Stroke Foundation (93T3LG4NPG)"

jobs:
  build-and-release:
    name: Build, Sign, Notarize & Release
    runs-on: macos-14

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Get version from tag
        id: version
        run: echo "VERSION=${GITHUB_REF#refs/tags/v}" >> $GITHUB_OUTPUT

      - name: Verify VERSION file matches tag
        run: |
          FILE_VERSION=$(cat VERSION | tr -d '\n')
          TAG_VERSION=${{ steps.version.outputs.VERSION }}
          if [ "$FILE_VERSION" != "$TAG_VERSION" ]; then
            echo "::error::VERSION file ($FILE_VERSION) doesn't match tag ($TAG_VERSION)"
            exit 1
          fi

      - name: Install dependencies
        run: brew install cjson

      - name: Select Xcode 16 (for Swift 6.0 / MLX support)
        run: |
          sudo xcode-select -s /Applications/Xcode_16.2.app/Contents/Developer
          swift --version
          echo "MLX Swift will be compiled with full Apple Silicon support"

      # --- Build All Editions ---
      - name: Build Master Edition
        run: |
          make clean && make EDITION=master
          mkdir -p dist/master
          cp build/bin/convergio dist/master/
          if [ -d build/bin/ConvergioNotify.app ]; then
            cp -r build/bin/ConvergioNotify.app dist/master/
          fi

      - name: Build Education Edition
        run: |
          make clean && make EDITION=education
          mkdir -p dist/education
          cp build/bin/convergio-edu dist/education/

      - name: Build Business Edition
        run: |
          make clean && make EDITION=business
          mkdir -p dist/business
          cp build/bin/convergio-biz dist/business/

      - name: Build Developer Edition
        run: |
          make clean && make EDITION=developer
          mkdir -p dist/developer
          cp build/bin/convergio-dev dist/developer/

      - name: Verify binaries
        run: |
          ./dist/master/convergio --version | grep "${{ steps.version.outputs.VERSION }}"
          ./dist/education/convergio-edu --version | grep "${{ steps.version.outputs.VERSION }}"
          ./dist/business/convergio-biz --version | grep "${{ steps.version.outputs.VERSION }}"
          ./dist/developer/convergio-dev --version | grep "${{ steps.version.outputs.VERSION }}"

      # --- Code Signing ---
      - name: Install Apple certificate
        env:
          P12_BASE64: ${{ secrets.APPLE_CERTIFICATE_P12 }}
          P12_PASSWORD: ${{ secrets.APPLE_CERTIFICATE_PASSWORD }}
        run: |
          # Create temporary keychain
          KEYCHAIN_PATH=$RUNNER_TEMP/app-signing.keychain-db
          KEYCHAIN_PASSWORD=$(openssl rand -base64 32)

          # Decode certificate
          echo "$P12_BASE64" | base64 --decode > $RUNNER_TEMP/certificate.p12

          # Create keychain
          security create-keychain -p "$KEYCHAIN_PASSWORD" $KEYCHAIN_PATH
          security set-keychain-settings -lut 21600 $KEYCHAIN_PATH
          security unlock-keychain -p "$KEYCHAIN_PASSWORD" $KEYCHAIN_PATH

          # Import certificate
          security import $RUNNER_TEMP/certificate.p12 -P "$P12_PASSWORD" -A -t cert -f pkcs12 -k $KEYCHAIN_PATH
          security list-keychain -d user -s $KEYCHAIN_PATH

          # Allow codesign to access keychain
          security set-key-partition-list -S apple-tool:,apple:,codesign: -s -k "$KEYCHAIN_PASSWORD" $KEYCHAIN_PATH

      - name: Sign all binaries
        run: |
          # Sign Master edition
          codesign --force --options runtime --sign "$DEVELOPER_ID" --timestamp ./dist/master/convergio
          codesign --verify --verbose ./dist/master/convergio
          if [ -d ./dist/master/ConvergioNotify.app ]; then
            codesign --force --options runtime --deep --sign "$DEVELOPER_ID" --timestamp ./dist/master/ConvergioNotify.app
            codesign --verify --verbose ./dist/master/ConvergioNotify.app
          fi

          # Sign Education edition
          codesign --force --options runtime --sign "$DEVELOPER_ID" --timestamp ./dist/education/convergio-edu
          codesign --verify --verbose ./dist/education/convergio-edu

          # Sign Business edition
          codesign --force --options runtime --sign "$DEVELOPER_ID" --timestamp ./dist/business/convergio-biz
          codesign --verify --verbose ./dist/business/convergio-biz

          # Sign Developer edition
          codesign --force --options runtime --sign "$DEVELOPER_ID" --timestamp ./dist/developer/convergio-dev
          codesign --verify --verbose ./dist/developer/convergio-dev

          echo "✓ All editions signed"

      # --- Notarization ---
      - name: Create ZIP for notarization
        run: |
          # Create combined ZIP with all binaries for notarization
          cd dist
          zip -r all-editions.zip master/ education/ business/ developer/
          cd ..

      - name: Notarize binaries
        env:
          APPLE_ID: ${{ secrets.APPLE_ID }}
          APPLE_APP_PASSWORD: ${{ secrets.APPLE_APP_PASSWORD }}
          APPLE_TEAM_ID: ${{ secrets.APPLE_TEAM_ID }}
        run: |
          xcrun notarytool submit dist/all-editions.zip \
            --apple-id "$APPLE_ID" \
            --password "$APPLE_APP_PASSWORD" \
            --team-id "$APPLE_TEAM_ID" \
            --wait

          # Staple notarization to the helper app if present
          if [ -d dist/master/ConvergioNotify.app ]; then
            xcrun stapler staple dist/master/ConvergioNotify.app || echo "Stapling helper app failed (non-fatal)"
          fi

      # --- Create Release Artifacts ---
      - name: Create tarballs
        run: |
          VERSION=${{ steps.version.outputs.VERSION }}

          # Master edition (includes ConvergioNotify.app if available)
          cd dist/master
          if [ -d ConvergioNotify.app ]; then
            tar -czvf ../convergio-${VERSION}-arm64-apple-darwin.tar.gz convergio ConvergioNotify.app
          else
            tar -czvf ../convergio-${VERSION}-arm64-apple-darwin.tar.gz convergio
          fi
          cd ../..

          # Education edition
          cd dist/education
          tar -czvf ../convergio-edu-${VERSION}-arm64-apple-darwin.tar.gz convergio-edu
          cd ../..

          # Business edition
          cd dist/business
          tar -czvf ../convergio-biz-${VERSION}-arm64-apple-darwin.tar.gz convergio-biz
          cd ../..

          # Developer edition
          cd dist/developer
          tar -czvf ../convergio-dev-${VERSION}-arm64-apple-darwin.tar.gz convergio-dev
          cd ../..

          echo "✓ All tarballs created"
          ls -la dist/*.tar.gz

      - name: Calculate SHA256 checksums
        id: sha256
        run: |
          VERSION=${{ steps.version.outputs.VERSION }}

          SHA_MASTER=$(shasum -a 256 dist/convergio-${VERSION}-arm64-apple-darwin.tar.gz | awk '{print $1}')
          SHA_EDU=$(shasum -a 256 dist/convergio-edu-${VERSION}-arm64-apple-darwin.tar.gz | awk '{print $1}')
          SHA_BIZ=$(shasum -a 256 dist/convergio-biz-${VERSION}-arm64-apple-darwin.tar.gz | awk '{print $1}')
          SHA_DEV=$(shasum -a 256 dist/convergio-dev-${VERSION}-arm64-apple-darwin.tar.gz | awk '{print $1}')

          echo "SHA256_MASTER=$SHA_MASTER" >> $GITHUB_OUTPUT
          echo "SHA256_EDU=$SHA_EDU" >> $GITHUB_OUTPUT
          echo "SHA256_BIZ=$SHA_BIZ" >> $GITHUB_OUTPUT
          echo "SHA256_DEV=$SHA_DEV" >> $GITHUB_OUTPUT

          echo "SHA256 Checksums:"
          echo "  Master:     $SHA_MASTER"
          echo "  Education:  $SHA_EDU"
          echo "  Business:   $SHA_BIZ"
          echo "  Developer:  $SHA_DEV"

      # --- Create GitHub Release ---
      - name: Create GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          files: |
            dist/convergio-${{ steps.version.outputs.VERSION }}-arm64-apple-darwin.tar.gz
            dist/convergio-edu-${{ steps.version.outputs.VERSION }}-arm64-apple-darwin.tar.gz
            dist/convergio-biz-${{ steps.version.outputs.VERSION }}-arm64-apple-darwin.tar.gz
            dist/convergio-dev-${{ steps.version.outputs.VERSION }}-arm64-apple-darwin.tar.gz
          body: |
            ## Convergio v${{ steps.version.outputs.VERSION }}

            Multi-agent AI orchestration CLI for Apple Silicon.

            ### Available Editions

            | Edition | Binary | Target Users | Download |
            |---------|--------|--------------|----------|
            | **Master** | `convergio` | Power users, full features | [Download](https://github.com/Roberdan/convergio-cli/releases/download/v${{ steps.version.outputs.VERSION }}/convergio-${{ steps.version.outputs.VERSION }}-arm64-apple-darwin.tar.gz) |
            | **Education** | `convergio-edu` | Schools, students (Scuola 2026) | [Download](https://github.com/Roberdan/convergio-cli/releases/download/v${{ steps.version.outputs.VERSION }}/convergio-edu-${{ steps.version.outputs.VERSION }}-arm64-apple-darwin.tar.gz) |
            | **Business** | `convergio-biz` | Enterprise, teams | [Download](https://github.com/Roberdan/convergio-cli/releases/download/v${{ steps.version.outputs.VERSION }}/convergio-biz-${{ steps.version.outputs.VERSION }}-arm64-apple-darwin.tar.gz) |
            | **Developer** | `convergio-dev` | Debug tools, APIs | [Download](https://github.com/Roberdan/convergio-cli/releases/download/v${{ steps.version.outputs.VERSION }}/convergio-dev-${{ steps.version.outputs.VERSION }}-arm64-apple-darwin.tar.gz) |

            ### Installation

            **Via Homebrew (Master Edition):**
            ```bash
            brew tap Roberdan/convergio-cli
            brew install convergio
            ```

            **Manual Installation (any edition):**
            ```bash
            # Download your preferred edition
            curl -LO https://github.com/Roberdan/convergio-cli/releases/download/v${{ steps.version.outputs.VERSION }}/convergio-edu-${{ steps.version.outputs.VERSION }}-arm64-apple-darwin.tar.gz

            # Extract
            tar -xzf convergio-edu-${{ steps.version.outputs.VERSION }}-arm64-apple-darwin.tar.gz

            # Install
            sudo mv convergio-edu /usr/local/bin/

            # Setup
            convergio-edu setup
            ```

            ### Binary Info
            - **Architecture:** arm64 (Apple Silicon)
            - **Signed:** Yes (Developer ID)
            - **Notarized:** Yes (Apple Notary Service)

            ### SHA256 Checksums
            | Edition | SHA256 |
            |---------|--------|
            | Master | `${{ steps.sha256.outputs.SHA256_MASTER }}` |
            | Education | `${{ steps.sha256.outputs.SHA256_EDU }}` |
            | Business | `${{ steps.sha256.outputs.SHA256_BIZ }}` |
            | Developer | `${{ steps.sha256.outputs.SHA256_DEV }}` |

            ### What's New
            See [CHANGELOG.md](https://github.com/Roberdan/convergio-cli/blob/main/CHANGELOG.md) for details.
          generate_release_notes: true

      # --- Update Homebrew Formulas (All Editions) ---
      - name: Update Homebrew Formulas
        env:
          TAP_GITHUB_TOKEN: ${{ secrets.TAP_GITHUB_TOKEN }}
        run: |
          VERSION=${{ steps.version.outputs.VERSION }}
          SHA256_MASTER=${{ steps.sha256.outputs.SHA256_MASTER }}
          SHA256_EDU=${{ steps.sha256.outputs.SHA256_EDU }}
          SHA256_BIZ=${{ steps.sha256.outputs.SHA256_BIZ }}
          SHA256_DEV=${{ steps.sha256.outputs.SHA256_DEV }}

          # Update Master formula
          sed -i '' "s/version \".*\"/version \"${VERSION}\"/" Formula/convergio.rb
          sed -i '' "s/sha256 \".*\"/sha256 \"${SHA256_MASTER}\"/" Formula/convergio.rb
          sed -i '' "s|/v[0-9]*\.[0-9]*\.[0-9]*/|/v${VERSION}/|g" Formula/convergio.rb
          sed -i '' "s/convergio-[0-9]*\.[0-9]*\.[0-9]*/convergio-${VERSION}/g" Formula/convergio.rb

          # Update Education formula
          sed -i '' "s/version \".*\"/version \"${VERSION}\"/" Formula/convergio-edu.rb
          sed -i '' "s/sha256 \".*\"/sha256 \"${SHA256_EDU}\"/" Formula/convergio-edu.rb
          sed -i '' "s|/v[0-9]*\.[0-9]*\.[0-9]*/|/v${VERSION}/|g" Formula/convergio-edu.rb
          sed -i '' "s/convergio-edu-[0-9]*\.[0-9]*\.[0-9]*/convergio-edu-${VERSION}/g" Formula/convergio-edu.rb

          # Update Business formula
          sed -i '' "s/version \".*\"/version \"${VERSION}\"/" Formula/convergio-biz.rb
          sed -i '' "s/sha256 \".*\"/sha256 \"${SHA256_BIZ}\"/" Formula/convergio-biz.rb
          sed -i '' "s|/v[0-9]*\.[0-9]*\.[0-9]*/|/v${VERSION}/|g" Formula/convergio-biz.rb
          sed -i '' "s/convergio-biz-[0-9]*\.[0-9]*\.[0-9]*/convergio-biz-${VERSION}/g" Formula/convergio-biz.rb

          # Update Developer formula
          sed -i '' "s/version \".*\"/version \"${VERSION}\"/" Formula/convergio-dev.rb
          sed -i '' "s/sha256 \".*\"/sha256 \"${SHA256_DEV}\"/" Formula/convergio-dev.rb
          sed -i '' "s|/v[0-9]*\.[0-9]*\.[0-9]*/|/v${VERSION}/|g" Formula/convergio-dev.rb
          sed -i '' "s/convergio-dev-[0-9]*\.[0-9]*\.[0-9]*/convergio-dev-${VERSION}/g" Formula/convergio-dev.rb

          # Update Homebrew tap repository with ALL formulas
          cd /tmp
          git clone https://x-access-token:${TAP_GITHUB_TOKEN}@github.com/Roberdan/homebrew-convergio-cli.git tap-repo
          cp $GITHUB_WORKSPACE/Formula/convergio.rb tap-repo/Formula/
          cp $GITHUB_WORKSPACE/Formula/convergio-edu.rb tap-repo/Formula/
          cp $GITHUB_WORKSPACE/Formula/convergio-biz.rb tap-repo/Formula/
          cp $GITHUB_WORKSPACE/Formula/convergio-dev.rb tap-repo/Formula/
          cd tap-repo
          git config user.name "GitHub Actions"
          git config user.email "actions@github.com"
          git add Formula/
          git diff --staged --quiet || git commit -m "chore: Update all formulas to v${VERSION}"
          git push origin main
          echo "✅ Homebrew tap updated to v${VERSION} (all 4 editions)"

      # --- Cleanup ---
      - name: Cleanup keychain
        if: always()
        run: |
          security delete-keychain $RUNNER_TEMP/app-signing.keychain-db || true
          rm -f $RUNNER_TEMP/certificate.p12 || true
