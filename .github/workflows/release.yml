name: Release

on:
  push:
    tags:
      - 'v*'

permissions:
  contents: write

env:
  DEVELOPER_ID: "Developer ID Application: Fight The Stroke Foundation (93T3LG4NPG)"

jobs:
  build-and-release:
    name: Build, Sign, Notarize & Release
    runs-on: macos-14

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Get version from tag
        id: version
        run: echo "VERSION=${GITHUB_REF#refs/tags/v}" >> $GITHUB_OUTPUT

      - name: Verify VERSION file matches tag
        run: |
          FILE_VERSION=$(cat VERSION | tr -d '\n')
          TAG_VERSION=${{ steps.version.outputs.VERSION }}
          if [ "$FILE_VERSION" != "$TAG_VERSION" ]; then
            echo "::error::VERSION file ($FILE_VERSION) doesn't match tag ($TAG_VERSION)"
            exit 1
          fi

      - name: Install dependencies
        run: brew install cjson

      - name: Select Xcode 16 (for Swift 6.0 / MLX support)
        run: |
          sudo xcode-select -s /Applications/Xcode_16.2.app/Contents/Developer
          swift --version
          echo "MLX Swift will be compiled with full Apple Silicon support"

      - name: Build release binary
        run: make clean && make

      - name: Verify binary
        run: |
          ./build/bin/convergio --version | grep "${{ steps.version.outputs.VERSION }}"

      # --- Code Signing ---
      - name: Install Apple certificate
        env:
          P12_BASE64: ${{ secrets.APPLE_CERTIFICATE_P12 }}
          P12_PASSWORD: ${{ secrets.APPLE_CERTIFICATE_PASSWORD }}
        run: |
          # Create temporary keychain
          KEYCHAIN_PATH=$RUNNER_TEMP/app-signing.keychain-db
          KEYCHAIN_PASSWORD=$(openssl rand -base64 32)

          # Decode certificate
          echo "$P12_BASE64" | base64 --decode > $RUNNER_TEMP/certificate.p12

          # Create keychain
          security create-keychain -p "$KEYCHAIN_PASSWORD" $KEYCHAIN_PATH
          security set-keychain-settings -lut 21600 $KEYCHAIN_PATH
          security unlock-keychain -p "$KEYCHAIN_PASSWORD" $KEYCHAIN_PATH

          # Import certificate
          security import $RUNNER_TEMP/certificate.p12 -P "$P12_PASSWORD" -A -t cert -f pkcs12 -k $KEYCHAIN_PATH
          security list-keychain -d user -s $KEYCHAIN_PATH

          # Allow codesign to access keychain
          security set-key-partition-list -S apple-tool:,apple:,codesign: -s -k "$KEYCHAIN_PASSWORD" $KEYCHAIN_PATH

      - name: Sign binary and notification helper
        run: |
          # Sign main binary
          codesign --force --options runtime --sign "$DEVELOPER_ID" \
            --timestamp ./build/bin/convergio
          codesign --verify --verbose ./build/bin/convergio

          # Sign notification helper app (if built)
          if [ -d ./build/bin/ConvergioNotify.app ]; then
            codesign --force --options runtime --deep --sign "$DEVELOPER_ID" \
              --timestamp ./build/bin/ConvergioNotify.app
            codesign --verify --verbose ./build/bin/ConvergioNotify.app
            echo "✓ ConvergioNotify.app signed"
          fi

      # --- Notarization ---
      - name: Create ZIP for notarization
        run: |
          cd build/bin
          # Include both convergio and ConvergioNotify.app
          if [ -d ConvergioNotify.app ]; then
            zip -r convergio.zip convergio ConvergioNotify.app
          else
            zip convergio.zip convergio
          fi
          cd ../..

      - name: Notarize binary
        env:
          APPLE_ID: ${{ secrets.APPLE_ID }}
          APPLE_APP_PASSWORD: ${{ secrets.APPLE_APP_PASSWORD }}
          APPLE_TEAM_ID: ${{ secrets.APPLE_TEAM_ID }}
        run: |
          xcrun notarytool submit build/bin/convergio.zip \
            --apple-id "$APPLE_ID" \
            --password "$APPLE_APP_PASSWORD" \
            --team-id "$APPLE_TEAM_ID" \
            --wait

          # Staple notarization to the helper app
          if [ -d build/bin/ConvergioNotify.app ]; then
            xcrun stapler staple build/bin/ConvergioNotify.app || echo "Stapling helper app failed (non-fatal)"
          fi

      # --- Create Release Artifacts ---
      - name: Create tarball
        run: |
          mkdir -p dist
          cd build/bin
          # Include ConvergioNotify.app if available
          if [ -d ConvergioNotify.app ]; then
            tar -czvf ../../dist/convergio-${{ steps.version.outputs.VERSION }}-arm64-apple-darwin.tar.gz convergio ConvergioNotify.app
          else
            tar -czvf ../../dist/convergio-${{ steps.version.outputs.VERSION }}-arm64-apple-darwin.tar.gz convergio
          fi
          cd ../..

      - name: Calculate SHA256
        id: sha256
        run: |
          SHA=$(shasum -a 256 dist/convergio-*.tar.gz | awk '{print $1}')
          echo "SHA256=$SHA" >> $GITHUB_OUTPUT
          echo "SHA256: $SHA"

      # --- Create GitHub Release ---
      - name: Create GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          files: dist/*.tar.gz
          body: |
            ## Convergio v${{ steps.version.outputs.VERSION }}

            Multi-agent AI orchestration CLI for Apple Silicon.

            ### Installation

            ```bash
            brew tap Roberdan/convergio-cli
            brew install convergio
            ```

            Or download the binary directly and run:
            ```bash
            tar -xzf convergio-${{ steps.version.outputs.VERSION }}-arm64-apple-darwin.tar.gz
            # Install notification helper for proper icon display
            cp -r ConvergioNotify.app /Applications/ 2>/dev/null || true
            ./convergio setup
            ```

            ### Binary Info
            - **Architecture:** arm64 (Apple Silicon)
            - **Signed:** Yes (Developer ID)
            - **Notarized:** Yes (Apple Notary Service)
            - **SHA256:** `${{ steps.sha256.outputs.SHA256 }}`

            ### First Run
            ```bash
            convergio setup
            ```

            ### What's New
            See [CHANGELOG.md](https://github.com/Roberdan/convergio-cli/blob/main/CHANGELOG.md) for details.
          generate_release_notes: true

      # --- Update Homebrew Formula ---
      - name: Update Homebrew Formula
        env:
          TAP_GITHUB_TOKEN: ${{ secrets.TAP_GITHUB_TOKEN }}
        run: |
          VERSION=${{ steps.version.outputs.VERSION }}
          SHA256=${{ steps.sha256.outputs.SHA256 }}

          # Update formula in main repo
          sed -i '' "s/version \".*\"/version \"${VERSION}\"/" Formula/convergio.rb
          sed -i '' "s/sha256 \".*\"/sha256 \"${SHA256}\"/" Formula/convergio.rb
          sed -i '' "s|/v[0-9]*\.[0-9]*\.[0-9]*/|/v${VERSION}/|g" Formula/convergio.rb
          sed -i '' "s/convergio-[0-9]*\.[0-9]*\.[0-9]*/convergio-${VERSION}/g" Formula/convergio.rb

          git config user.name "GitHub Actions"
          git config user.email "actions@github.com"
          git add Formula/convergio.rb
          git commit -m "chore: Update Homebrew formula to v${VERSION}" || echo "No changes to commit"
          git push origin HEAD:main || echo "Push failed - may need manual update"

          # Update Homebrew tap repository
          cd /tmp
          git clone https://x-access-token:${TAP_GITHUB_TOKEN}@github.com/Roberdan/homebrew-convergio-cli.git tap-repo
          cp $GITHUB_WORKSPACE/Formula/convergio.rb tap-repo/Formula/
          cd tap-repo
          git config user.name "GitHub Actions"
          git config user.email "actions@github.com"
          git add Formula/convergio.rb
          git commit -m "chore: Update formula to v${VERSION}"
          git push origin main
          echo "✅ Homebrew tap updated to v${VERSION}"

      # --- Cleanup ---
      - name: Cleanup keychain
        if: always()
        run: |
          security delete-keychain $RUNNER_TEMP/app-signing.keychain-db || true
          rm -f $RUNNER_TEMP/certificate.p12 || true
