name: Nightly

on:
  schedule:
    - cron: '0 3 * * *'  # 3 AM UTC daily
  workflow_dispatch:  # Manual trigger

env:
  XCODE_VERSION: /Applications/Xcode_16.2.app/Contents/Developer

jobs:
  sanitizer-tests:
    name: Sanitizer Tests (ASAN + UBSan)
    runs-on: macos-14

    steps:
      - uses: actions/checkout@v4

      - name: Install dependencies
        run: |
          brew install cjson ccache
          brew link cjson --overwrite 2>/dev/null || true

      - name: Cache ccache
        uses: actions/cache@v4
        with:
          path: ~/.ccache
          key: ccache-sanitizer-${{ runner.os }}-${{ hashFiles('src/**/*.c', 'include/**/*.h') }}
          restore-keys: ccache-${{ runner.os }}-

      - name: Configure ccache
        run: |
          ccache --set-config=max_size=300M
          ccache --set-config=compression=true
          ccache -z

      - name: Select Xcode
        run: sudo xcode-select -s ${{ env.XCODE_VERSION }}

      - name: Build with sanitizers
        run: |
          export PATH="/opt/homebrew/opt/ccache/libexec:$PATH"
          make clean
          make unit_test DEBUG=1 CC="ccache clang" 2>&1

      - name: Run tests with sanitizers
        run: |
          export ASAN_OPTIONS="abort_on_error=1"
          export UBSAN_OPTIONS="print_stacktrace=1:halt_on_error=1"
          ./build/bin/unit_test

      - name: Build and run fuzz tests
        run: |
          export PATH="/opt/homebrew/opt/ccache/libexec:$PATH"
          make fuzz_test DEBUG=1 CC="ccache clang"
          timeout 60 ./build/bin/fuzz_test 2>&1 || true

      - name: Show ccache stats
        run: ccache -s
