name: CI

on:
  pull_request:
    branches: [main]
  push:
    branches: [main]

# Cancel in-progress runs for the same branch
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

env:
  XCODE_VERSION: /Applications/Xcode_16.2.app/Contents/Developer

jobs:
  # ============================================================================
  # FAST CHECKS - combined job for quick feedback (no build deps)
  # ============================================================================

  lint-and-analysis:
    name: Lint & Static Analysis
    runs-on: macos-14
    steps:
      - uses: actions/checkout@v4

      # --- Security & Quality Checks (instant) ---
      - name: Security scan
        run: |
          echo "=== Checking for hardcoded secrets ==="
          ! grep -rE "(api[_-]?key|secret|password|token)\s*=" --include="*.c" --include="*.h" src include 2>/dev/null | grep -v "getenv" | grep -v "keychain" | grep -v "// " || echo "::warning::Potential secrets found"

          echo "=== Checking for dangerous functions ==="
          ! grep -rE "\b(gets|sprintf|strcpy|strcat|scanf)\s*\(" --include="*.c" src 2>/dev/null || echo "::warning::Dangerous functions found"

      - name: Code quality
        run: |
          echo "=== Checking for TODO/FIXME ==="
          grep -rE "(TODO|FIXME)" --include="*.c" --include="*.h" src include 2>/dev/null | head -10 || true

      # --- Static Analysis (with caching) ---
      - name: Cache LLVM
        id: cache-llvm
        uses: actions/cache@v4
        with:
          path: /opt/homebrew/opt/llvm
          key: llvm-macos-14-arm64-v1

      - name: Install clang-tidy
        if: steps.cache-llvm.outputs.cache-hit != 'true'
        run: brew install llvm

      - name: Run clang-tidy
        continue-on-error: true
        run: |
          # Run clang-tidy on all .c files (no limit - full analysis)
          export PATH="/opt/homebrew/opt/llvm/bin:$PATH"
          echo "=== Running clang-tidy on all source files ==="
          find src -name "*.c" -type f | xargs -P4 -I{} sh -c 'echo "Checking {}..." && clang-tidy {} -- -Iinclude -std=c17 2>&1 || true'

  # ============================================================================
  # BUILD - single job that produces all artifacts with ccache
  # ============================================================================

  build:
    name: Build
    runs-on: macos-14
    outputs:
      cache-key: ${{ steps.cache-key.outputs.key }}

    steps:
      - uses: actions/checkout@v4

      - name: Generate cache key
        id: cache-key
        run: |
          # Cache key based on source files hash
          echo "key=build-${{ runner.os }}-${{ hashFiles('src/**/*.c', 'include/**/*.h', 'Makefile') }}" >> $GITHUB_OUTPUT

      # --- Dependencies (install fresh to avoid dylib version mismatches) ---
      - name: Install dependencies
        run: |
          brew install cjson ccache
          brew link cjson --overwrite 2>/dev/null || true
          brew link ccache --overwrite 2>/dev/null || true

      # --- Compilation cache ---
      - name: Cache ccache
        uses: actions/cache@v4
        with:
          path: ~/.ccache
          key: ccache-${{ runner.os }}-${{ hashFiles('src/**/*.c', 'include/**/*.h') }}
          restore-keys: |
            ccache-${{ runner.os }}-

      - name: Configure ccache
        run: |
          ccache --set-config=max_size=500M
          ccache --set-config=compression=true
          ccache -z  # Reset stats

      - name: Select Xcode
        run: sudo xcode-select -s ${{ env.XCODE_VERSION }}

      # --- Build all targets in parallel ---
      - name: Build release
        run: |
          export PATH="/opt/homebrew/opt/ccache/libexec:$PATH"
          make clean
          make CC="ccache clang" 2>&1 | tee build-release.log

      - name: Check warnings
        run: |
          if grep -i "warning:" build-release.log | grep -v "Metal Toolchain" | grep -v "Swift build failed"; then
            echo "::error::Build produced warnings"
            exit 1
          fi

      - name: Build debug
        run: |
          export PATH="/opt/homebrew/opt/ccache/libexec:$PATH"
          make debug CC="ccache clang" 2>&1

      - name: Build and run unit tests
        run: |
          export PATH="/opt/homebrew/opt/ccache/libexec:$PATH"
          make unit_test CC="ccache clang"
          echo "=== Running unit tests ==="
          ./build/bin/unit_test

      - name: Build and run fuzz tests
        run: |
          export PATH="/opt/homebrew/opt/ccache/libexec:$PATH"
          make fuzz_test CC="ccache clang"
          echo "=== Running fuzz tests (quick mode) ==="
          timeout 30 ./build/bin/fuzz_test 2>&1 || true

      - name: Show ccache stats
        run: ccache -s

      # --- Upload artifacts ---
      - name: Upload release binary
        uses: actions/upload-artifact@v4
        with:
          name: convergio-release
          path: build/bin/convergio
          retention-days: 7

  # ============================================================================
  # SANITIZER TESTS - memory and undefined behavior detection
  # ============================================================================

  sanitizer-tests:
    name: Sanitizer Tests
    runs-on: macos-14
    needs: build

    steps:
      - uses: actions/checkout@v4

      - name: Install dependencies
        run: |
          brew install cjson
          brew link cjson --overwrite 2>/dev/null || true

      - name: Select Xcode
        run: sudo xcode-select -s ${{ env.XCODE_VERSION }}

      # Build with sanitizers enabled (AddressSanitizer + UndefinedBehaviorSanitizer)
      # DEBUG=1 in Makefile enables: -fsanitize=address,undefined
      - name: Build with sanitizers
        run: |
          echo "=== Building with AddressSanitizer and UBSan (DEBUG=1) ==="
          make clean
          make unit_test DEBUG=1 2>&1

      - name: Run unit tests with sanitizers
        run: |
          echo "=== Running unit tests with sanitizers ==="
          # ASAN_OPTIONS: detect memory issues, abort on error
          # UBSAN_OPTIONS: print stack trace on UB detection
          export ASAN_OPTIONS="abort_on_error=1:detect_leaks=1"
          export UBSAN_OPTIONS="print_stacktrace=1:halt_on_error=1"
          ./build/bin/unit_test

  # ============================================================================
  # E2E TESTS - uses release artifact (no rebuild)
  # ============================================================================

  e2e-tests:
    name: E2E Tests
    runs-on: macos-14
    needs: build

    steps:
      - uses: actions/checkout@v4

      - name: Download release binary
        uses: actions/download-artifact@v4
        with:
          name: convergio-release
          path: build/bin

      - name: Make binary executable
        run: chmod +x build/bin/convergio

      - name: Install coreutils for gtimeout
        run: brew install coreutils

      - name: Run E2E tests
        run: |
          chmod +x tests/e2e_test.sh
          ./tests/e2e_test.sh 2>&1
        timeout-minutes: 5

  # ============================================================================
  # FINAL STATUS - aggregates all job results
  # ============================================================================

  ci-success:
    name: CI Success
    runs-on: macos-14
    needs: [lint-and-analysis, build, sanitizer-tests, e2e-tests]
    if: always()
    steps:
      - name: Check all jobs passed
        run: |
          # All jobs are now required (E2E quiet mode banner fixed)
          if [ "${{ needs.lint-and-analysis.result }}" != "success" ] || \
             [ "${{ needs.build.result }}" != "success" ] || \
             [ "${{ needs.sanitizer-tests.result }}" != "success" ] || \
             [ "${{ needs.e2e-tests.result }}" != "success" ]; then
            echo "::error::One or more required jobs failed"
            exit 1
          fi
          echo "All CI checks passed!"
